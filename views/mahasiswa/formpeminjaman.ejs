<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>Form Peminjaman Buku</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&amp;display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
    </style>
  </head>
  <body class="bg-[#f3f9f2]">
    <%- include('../partials/navbarMahasiswa') %>
    <main
      class="max-w-5xl mx-auto mt-28 p-8 pt-12 bg-white rounded-md border border-[#2f6f4e] shadow-sm"
    >
      <h1 class="text-[#2f6f4e] font-semibold text-xl mb-8">
        Form Peminjaman Buku
      </h1>

      <!-- Alert untuk pesan -->
      <div id="alert" class="mb-4 hidden"></div>

      <form id="formPeminjaman" class="flex flex-col md:flex-row md:space-x-20">
        <section class="flex-1">
          <h2
            class="text-[#2f6f4e] font-semibold text-base border-b border-[#2f6f4e] pb-1 mb-6"
          >
            Informasi Mahasiswa
          </h2>
          <div class="mb-5">
            <label
              class="block text-xs font-semibold text-[#2f6f4e] mb-1"
              for="nama"
            >
              Nama Lengkap
            </label>
            <input
              autocomplete="name"
              class="w-full text-xs text-[#2f6f4e] border border-[#2f6f4e] rounded-md bg-[#e6f0e9] px-2 py-1"
              id="nama"
              type="text"
              value="<%= pengguna ? pengguna.nama_lengkap : '' %>"
              readonly
            />
          </div>
          <div class="mb-5">
            <label
              class="block text-xs font-semibold text-[#2f6f4e] mb-1"
              for="nim"
            >
              Nomor Induk Mahasiswa
            </label>
            <input
              autocomplete="student-id"
              class="w-full text-xs text-[#2f6f4e] border border-[#2f6f4e] rounded-md bg-[#e6f0e9] px-2 py-1"
              id="nim"
              type="text"
              value="<%= pengguna ? pengguna.id_pengguna : '' %>"
              readonly
            />
          </div>
          <div>
            <label
              class="block text-xs font-semibold text-[#2f6f4e] mb-1"
              for="email"
            >
              Email
            </label>
            <input
              autocomplete="email"
              class="w-full text-xs text-[#2f6f4e] border border-[#2f6f4e] rounded-md bg-[#e6f0e9] px-2 py-1"
              id="email"
              type="email"
              value="<%= pengguna ? pengguna.email : '' %>"
              readonly
            />
          </div>
        </section>
        <section class="flex-1 mt-10 md:mt-0">
          <h2
            class="text-[#2f6f4e] font-semibold text-base border-b border-[#2f6f4e] pb-1 mb-6"
          >
            Informasi Buku
          </h2>

          <!-- Hidden input untuk ISBN -->
          <input
            type="hidden"
            name="nomor_isbn"
            value="<%= buku ? buku.nomor_isbn : '' %>"
          />

          <div class="mb-5">
            <label
              class="block text-xs font-semibold text-[#2f6f4e] mb-1"
              for="judul"
            >
              Judul Buku
            </label>
            <input
              class="w-full text-xs text-[#2f6f4e] border border-[#2f6f4e] rounded-md bg-[#e6f0e9] px-2 py-1"
              id="judul"
              type="text"
              value="<%= buku ? buku.judul_buku : '' %>"
              readonly
            />
          </div>
          <div class="mb-5">
            <label
              class="block text-xs font-semibold text-[#2f6f4e] mb-1"
              for="pengarang"
            >
              Pengarang
            </label>
            <input
              class="w-full text-xs text-[#2f6f4e] border border-[#2f6f4e] rounded-md bg-[#e6f0e9] px-2 py-1"
              id="pengarang"
              type="text"
              value="<%= buku ? buku.pengarang : '' %>"
              readonly
            />
          </div>
          <div class="mb-5">
            <label
              class="block text-xs font-semibold text-[#2f6f4e] mb-1"
              for="isbn"
            >
              Nomor ISBN
            </label>
            <input
              class="w-full text-xs text-[#2f6f4e] border border-[#2f6f4e] rounded-md bg-[#e6f0e9] px-2 py-1"
              id="isbn"
              type="text"
              value="<%= buku ? buku.nomor_isbn : '' %>"
              readonly
            />
          </div>
          <div class="mb-5">
            <label
              class="block text-xs font-semibold text-[#2f6f4e] mb-1"
              for="lokasi"
            >
              Lokasi Buku
            </label>
            <input
              class="w-full text-xs text-[#2f6f4e] border border-[#2f6f4e] rounded-md bg-[#e6f0e9] px-2 py-1"
              id="lokasi"
              type="text"
              value="<%= buku ? buku.lokasi_penyimpanan : '' %>"
              readonly
            />
          </div>
          <div class="mb-8">
            <label
              class="block text-xs font-semibold text-[#2f6f4e] mb-1"
              for="tanggal"
            >
              Tanggal Pinjam <span class="text-red-500">*</span>
            </label>
            <input
              autocomplete="off"
              class="w-full text-xs text-[#2f6f4e] border border-[#2f6f4e] rounded-md bg-white px-2 py-1"
              id="tanggal"
              name="tanggal_peminjaman"
              type="date"
              required
            />
          </div>
          <div class="flex space-x-3 justify-end">
            <button
              class="bg-gray-500 text-white text-xs font-semibold rounded px-4 py-1 hover:bg-gray-600"
              type="button"
              onclick="window.history.back()"
            >
              Batal
            </button>
            <button
              id="btnPinjam"
              class="bg-[#2f6f4e] text-white text-xs font-semibold rounded px-4 py-1 hover:bg-[#255c3f]"
              type="submit"
            >
              Pinjam
            </button>
          </div>
        </section>
      </form>
    </main>

    <script>
      // Set minimum date to today
      document.addEventListener("DOMContentLoaded", function () {
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("tanggal").setAttribute("min", today);
      });

      // Handle form submission
      document
        .getElementById("formPeminjaman")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const btnPinjam = document.getElementById("btnPinjam");
          const alert = document.getElementById("alert");

          // Disable button to prevent double submission
          btnPinjam.disabled = true;
          btnPinjam.textContent = "Memproses...";

          const formData = new FormData(this);

          try {
            const response = await fetch("/mahasiswa/formpeminjaman", {
              method: "POST",
              body: formData,
            });

            const result = await response.json();

            if (result.success) {
              // Show success message
              alert.className =
                "mb-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded";
              alert.textContent =
                result.message +
                ". Tanggal wajib pengembalian: " +
                result.data.tanggal_wajib_pengembalian;
              alert.classList.remove("hidden");

              // Redirect after 3 seconds
              setTimeout(() => {
                window.location.href = "/mahasiswa/koleksibuku";
              }, 3000);
            } else {
              // Show error message
              alert.className =
                "mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded";
              alert.textContent = result.message;
              alert.classList.remove("hidden");
            }
          } catch (error) {
            console.error("Error:", error);
            alert.className =
              "mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded";
            alert.textContent = "Terjadi kesalahan sistem. Silakan coba lagi.";
            alert.classList.remove("hidden");
          } finally {
            // Re-enable button
            btnPinjam.disabled = false;
            btnPinjam.textContent = "Pinjam";
          }
        });
    </script>
  </body>
</html>
